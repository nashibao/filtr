/**
 * filtr - MongoDB inspired array filtering
 * Copyright(c) 2012 Jake Luer <jake@alogicalparadox.com>
 * @see https://github.com/logicalparadox/filtr
 * MIT Licensed
 */

!function(a,b){typeof module!="undefined"?module.exports=b():typeof define=="function"&&typeof define.amd=="object"?define(b):this[a]=b()}("filtr",function(){function d(a,b){if(a&&b)for(var c in b)"undefined"==typeof a[c]&&(a[c]=b[c]);return a}function e(a){if(global==this)return new e(a);this.query=a,this.stack=j(a)}function f(a){var b=a.replace(/\[/g,".["),c=b.match(/(\\\.|[^.]+?)+/g);return c.map(function(a){var b=/\[(\d+)\]$/,c=b.exec(a);return c?{i:parseFloat(c[1])}:{p:a}})}function g(a,b){var c=b,d;for(var e=0,f=a.length;e<f;e++){var g=a[e];c?("undefined"!=typeof g.p?c=c[g.p]:"undefined"!=typeof g.i&&(c=c[g.i]),e==f-1&&(d=c)):d=undefined}return d}function h(a,b){if(b==null)return[];var c=a[0],d=!1;"undefined"!=typeof c.p?d=c.p:"undefined"!=typeof c.i&&(d=c.i);var e=a.slice(1,a.length);if(!Array.isArray(b)){var f=b[d];if(a.length==1)return f!=null?Array.isArray(f)?f:[f]:[];if(f!=null){var f=h(e,f);return f}return[]}var g=[];return b.forEach(function(b){if(b!=null){var c=h(a,b);c.forEach(function(a){g.push(a)})}}),g}function i(a,b,c){var d=c;for(var e=0,f=a.length;e<f;e++){var g=a[e];if("undefined"!=typeof d)if(e==f-1)"undefined"!=typeof g.p?d[g.p]=b:"undefined"!=typeof g.i&&(d[g.i]=b);else if("undefined"!=typeof g.p&&d[g.p])d=d[g.p];else if("undefined"!=typeof g.i&&d[g.i])d=d[g.i];else{var h=a[e+1];"undefined"!=typeof g.p?(d[g.p]={},d=d[g.p]):"undefined"!=typeof g.i&&(d[g.i]=[],d=d[g.i])}else e==f-1?d=b:"undefined"!=typeof g.p?d={}:"undefined"!=typeof g.i&&(d=[])}}function j(a){var b=[];for(var c in a){var d={},e=a[c];c[0]=="$"?d.test=k(a):"string"==typeof e||"number"==typeof e||"boolean"==typeof e||e instanceof RegExp?(d.test=k({$eq:e}),d.path=f(c)):(d.test=k(e),d.path=f(c)),b.push(d)}return b}function k(a){var c=[];for(var d in a){var f=e.comparators[d],g=a[d],h=!1;if(b[d]){var i=[];h=!0;for(var k=0;k<g.length;k++){var l=g[k];if("string"==typeof l||"number"==typeof l||"boolean"==typeof l)h=!1;else var m=j(l);i.push(m)}}c.push({test:d,fn:f,params:h?i:g,traverse:h})}return c}function l(a,b){for(var c=0,d=b.length;c<d;c++){var e=b[c],f=e.path?h(e.path,a):a;Array.isArray(f)||(f=[f]);if(!m(f,e.test))return!1}return!0}function m(a,b){for(var d=0;d<b.length;d++){var e=b[d],f=e.params;if(e.traverse){var g=[];for(var h=0;h<f.length;h++)g.push(l(a,f[h]));f=g}if(a.length==0){if(!e.fn(undefined,f))return!1;break}if(e.fn!=undefined)if(e.fn.length==1){if(!e.fn(f))return!1}else if(c[e.test]){if(!e.fn(a,f))return!1}else{var i=!1;for(var j=0;j<a.length;j++)e.fn(a[j],f)&&(i=!0);if(!i)return!1}}return!0}if(!a)var a={};var b={$and:!0,$or:!0,$nor:!0},c={$all:!0,$elemMatch:!0,$size:!0};return a.exports=e,e.version="0.3.0",_eq=function(a,b){return b instanceof RegExp?b.test(a):a==b},_in=function(a,b){return b.length==0?!0:b.some(function(b){return _eq(a,b)})},_all=function(a,b){return b.length==0?!0:b.every(function(b){return a.some(function(a){return _eq(a,b)})})},e.comparators={$gt:function(a,b){return a>b},$gte:function(a,b){return a>=b},$lt:function(a,b){return a<b},$lte:function(a,b){return a<=b},$regex:function(a,b){return typeof a=="string"&&(new RegExp(b)).test(a)},$all:function(a,b){return _all(a,b)},$exists:function(a,b){return!!a==b},$mod:function(a,b){return a%b[0]==b[1]},$eq:function(a,b){return _eq(a,b)},$ne:function(a,b){return!_eq(a,b)},$not:function(a,b){return!_eq(a,b)},$in:function(a,b){return _in(a,b)},$nin:function(a,b){return!_in(a,b)},$size:function(a,b){return a.length&&b?a.length==b:!1},$or:function(a){var b=!1;for(var c=0;c<a.length;c++){var d=a[c];d&&(b=!0)}return b},$nor:function(a){var b=!0;for(var c=0;c<a.length;c++){var d=a[c];d&&(b=!1)}return b},$and:function(a){var b=!0;for(var c=0;c<a.length;c++){var d=a[c];d||(b=!1)}return b}},e.getPathValue=function(a,b){var c=f(a);return g(c,b)},e.getPathValues=function(a,b){var c=f(a);return h(c,b)},e.setPathValue=function(a,b,c){var d=f(a);i(d,b,c)},e.prototype.test=function(a,b){var c={type:"set",spec:"subset"},e=d(b||{},c),f=e.type=="single"?!1:[];e.type=="single"&&(a=[a]);for(var g=0,h=a.length;g<h;g++){var i=a[g],j=l(i,this.stack);if(e.type=="single")f=j;else switch(e.spec){case"boolean":f.push(j);break;case"index":j&&f.push(g);break;default:j&&f.push(i)}}return f},a.exports})